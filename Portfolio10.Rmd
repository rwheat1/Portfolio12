---
title: "Portfolio 10 -- More Moral Character!"
author: "Ryan Wheat"
date: "05/08/2023"
output: github_document
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r load-packages, include = FALSE}
library(tidyr)
library(tidyverse)
library(dplyr)
library(haven)
library(lmerTest)
```

```{r load-data, include = FALSE}

RAPTOR <- read_csv("C://Users/12107/OneDrive/Documents/GitHub/Portfolios 2023/Portfolio12/modern_RAPTOR_by_team.csv")

```

## Background

It's a cliche in the sports world to joke that the NBA playoffs are a completely different sport from the Regular Season. There are typically two points made to support this. (1) Players generally play much harder when the stakes are higher, and (2) the "clutch" players rise to the occasion much more often, such that the truly great ones can sometimes refuse to let their teams lose on a day when they normally might.

These perceived differences make playoff basketball a joy to watch, but does the empirical evidence support these positions? Do the great players actually perform better in the playoffs? That's what my final portfolio is going to examine today.

I've downloaded data from fivethirtyeight.com containing their advanced metrics on all NBA players from 2014-present. I am going to split this file up between the regular season and the playoffs, and see if any consistent differences emerge in the quality of play from certain players.

```{r wrangling}

#sort data so that each player included has data from the regular season and playoffs for a given year

RAPTOR_filtered <- RAPTOR %>%
  group_by(player_id, season) %>%
  mutate(filter_by = if_else(length(season) > 1 & length(season) <= 2, 1, 0)) %>%
  ungroup()

RAPTOR_filtered <- RAPTOR_filtered %>%
  group_by(player_id, season) %>%
  filter(filter_by == 1) %>%
  ungroup()

#there are some people who were on multiple teams in a given season that did not make the playoffs. Let's filter those players out.

RAPTOR_filtered <- RAPTOR_filtered %>%
  group_by(player_id, season) %>%
  filter("PO" %in% season_type) %>%
  ungroup()

RAPTOR_filtered %>%
  count(season_type)

```

Okay, we've now got a dataset of players who played for a given team in a given year during both the regular season and the playoffs.

Let's now do a median split on total_RAPTOR to seperate the "good" players from the "bad" players. We'll also seperate by +-1 standard deviation on total_RAPTOR. Then, we will assess if season_type (Regular Season vs. Playoffs) moderates how good these players are.

```{r splitting}

#regular season and playoff data

RAPTOR_rs <- RAPTOR_filtered %>%
  filter(season_type == "RS")

RAPTOR_po <- RAPTOR_filtered %>%
  filter(season_type == "PO")

#median split

RAPTOR_median_rs <- RAPTOR_rs %>%
  mutate(median_split = case_when(raptor_total > median(raptor_total) ~ "Good Player",
                                  raptor_total < median(raptor_total) ~ "Bad Player",
                                  raptor_total == median(raptor_total) ~ "Average Player"))

RAPTOR_median_po <- RAPTOR_po %>%
  mutate(median_split = case_when(raptor_total > median(raptor_total) ~ "Good Player",
                                  raptor_total < median(raptor_total) ~ "Bad Player",
                                  raptor_total == median(raptor_total) ~ "Average Player"))


#+/- 1 SD split

raptor_mean <- mean(RAPTOR_filtered$raptor_total)
raptor_sd <- sd(RAPTOR_filtered$raptor_total)

RAPTOR_SD_rs <- RAPTOR_rs %>%
  mutate(sd_split = case_when(raptor_total > raptor_mean + raptor_sd ~ "Good Player",
                              raptor_total < raptor_mean - raptor_sd ~ "Bad Player",
                              .default = "Average Player"))

RAPTOR_SD_po <- RAPTOR_po %>%
  mutate(sd_split = case_when(raptor_total > raptor_mean + raptor_sd ~ "Good Player",
                              raptor_total < raptor_mean - raptor_sd ~ "Bad Player",
                              .default = "Average Player"))

#put the regular season evaluations into the playoff datasets

RAPTOR_median_rs %>%
  arrange(player_id)

RAPTOR_SD_rs %>%
  arrange(player_id)

RAPTOR_po <- RAPTOR_po %>%
  arrange(player_id) %>%
  mutate(reg_median_split = RAPTOR_median_rs$median_split) %>%
  mutate(reg_sd_split = RAPTOR_SD_rs$sd_split) %>%
  mutate(reg_raptor = RAPTOR_SD_rs$raptor_total)

```

## Main Analyses

Ok, now that we've set that up, I'm going to run a series of regression models. If I were doing the full thing for this, I would probably run something to account for potential lack of independent observations (e.g., players nested within teams, nested within years). But I'm not going to do all that today.

First, I will see if the dichotomous variable of season_type predicts total_raptor. In other words: do players generally play better or worse in the playoffs?

```{r playoffs}

#create variable to show that the same person is 

po_v_rs <- lm(raptor_total ~ season_type, RAPTOR_filtered)

summary(po_v_rs)

```
This suggests that the playoffs vs. regular season distinction doesn't matter. That is, players do not generally play better or worse in the playoffs than they do in the regular season.

Next, I will run a regression model to see whether each player's playoff total_raptor can be predicted by their regular season total_raptor. I expect this to be a strong relationship.

```{r regular-season-predictor}

reg_po_raptor <- lm(raptor_total ~ reg_raptor, RAPTOR_po)

summary(reg_po_raptor)

```

Good -- the higher a player's regular season RAPTOR, the higher their postseason RAPTOR in a given year. You would hope this would be the case if a metric such as RAPTOR was supposed to be a good measure of how good a basketball player was.



